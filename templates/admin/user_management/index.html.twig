{% extends '_admin_layout.html.twig' %}

{% block title %}User Management{% endblock %}

{% block page_title %}User Management{% endblock %}
{% block page_subtitle %}Manage admin and staff accounts{% endblock %}

{% block admin_content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <!-- Total Users Card -->
  <div class="bg-white rounded-xl shadow p-6 flex items-center gap-4">
    <div class="flex-shrink-0">
      <div class="flex items-center justify-center h-12 w-12 rounded-lg bg-green-500 text-white text-2xl">
        ğŸ‘¥
      </div>
    </div>
    <div>
      <p class="text-gray-500 text-sm font-medium">Total Users</p>
      <p class="text-3xl font-bold text-gray-900">{{ users|length }}</p>
    </div>
  </div>

  <!-- Admin Accounts Card -->
  <div class="bg-white rounded-xl shadow p-6 flex items-center gap-4">
    <div class="flex-shrink-0">
      <div class="flex items-center justify-center h-12 w-12 rounded-lg bg-red-500 text-white text-2xl">
        ğŸ‘‘
      </div>
    </div>
    <div>
      <p class="text-gray-500 text-sm font-medium">Admin Accounts</p>
      <p class="text-3xl font-bold text-gray-900">
        {% set admin_count = 0 %}
        {% for user in users %}
          {% if 'ROLE_ADMIN' in user.roles %}
            {% set admin_count = admin_count + 1 %}
          {% endif %}
        {% endfor %}
        {{ admin_count }}
      </p>
    </div>
  </div>

  <!-- Staff Accounts Card -->
  <div class="bg-white rounded-xl shadow p-6 flex items-center gap-4">
    <div class="flex-shrink-0">
      <div class="flex items-center justify-center h-12 w-12 rounded-lg bg-blue-500 text-white text-2xl">
        ğŸ‘”
      </div>
    </div>
    <div>
      <p class="text-gray-500 text-sm font-medium">Staff Accounts</p>
      <p class="text-3xl font-bold text-gray-900">
        {% set staff_count = 0 %}
        {% for user in users %}
          {% if 'ROLE_STAFF' in user.roles %}
            {% set staff_count = staff_count + 1 %}
          {% endif %}
        {% endfor %}
        {{ staff_count }}
      </p>
    </div>
  </div>
</div>

<!-- Users Table Section -->
<div class="bg-white rounded-xl shadow overflow-hidden">
  <div class="p-6 border-b border-gray-200 flex justify-between items-center">
    <h2 class="text-2xl font-bold text-gray-800">Users Table</h2>
    <a href="{{ path('app_user_management_new') }}"
       class="inline-flex items-center gap-2 bg-[#D62828] text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition">
      <span class="text-xl">+</span> Add New User
    </a>
  </div>

  {% if users is not empty %}
    <div class="overflow-x-auto">
      <table id="usersTable" class="w-full display">
        <thead>
          <tr>
            <th>Username</th>
            <th>Role</th>
            <th>Active</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
            <tr>
              <td>{{ user.username }}</td>
              <td>
                {% if 'ROLE_ADMIN' in user.roles %}
                  <span class="inline-flex items-center gap-1 bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-semibold">
                    ğŸ‘‘ Admin
                  </span>
                {% elseif 'ROLE_STAFF' in user.roles %}
                  <span class="inline-flex items-center gap-1 bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-semibold">
                    ğŸ‘” Staff
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1 bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-semibold">
                    ğŸ‘¤ User
                  </span>
                {% endif %}
              </td>
              <td>
                {% if user.isActive %}
                  <span class="inline-flex items-center gap-1 bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">
                    âœ“ Active
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1 bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-semibold">
                    âœ— Inactive
                  </span>
                {% endif %}
              </td>
              <td>
                {{ user.createdAt ? user.createdAt|date('M d, Y') : 'N/A' }}
              </td>
              <td>
                <div class="flex gap-2">
                  <a href="{{ path('app_user_management_edit', {'id': user.id}) }}"
                     class="inline-flex items-center gap-1 text-gray-700 hover:text-gray-900 font-semibold px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                    âœï¸ Edit
                  </a>
                  {% if user.isActive %}
                    <form method="post" 
                          action="{{ path('app_user_management_deactivate', {'id': user.id}) }}"
                          onsubmit="return confirm('Are you sure you want to deactivate this user?');"
                          class="inline">
                      <input type="hidden" name="_token" value="{{ csrf_token('deactivate' ~ user.id) }}">
                      <button class="inline-flex items-center gap-1 text-orange-600 hover:text-orange-700 font-semibold px-3 py-1 border border-orange-300 rounded-lg hover:bg-orange-50 transition">
                        ğŸ”’ Deactivate
                      </button>
                    </form>
                  {% else %}
                    <form method="post" 
                          action="{{ path('app_user_management_activate', {'id': user.id}) }}"
                          onsubmit="return confirm('Are you sure you want to activate this user?');"
                          class="inline">
                      <input type="hidden" name="_token" value="{{ csrf_token('activate' ~ user.id) }}">
                      <button class="inline-flex items-center gap-1 text-green-600 hover:text-green-700 font-semibold px-3 py-1 border border-green-300 rounded-lg hover:bg-green-50 transition">
                        ğŸ”“ Activate
                      </button>
                    </form>
                  {% endif %}
                  <form method="post" 
                        action="{{ path('app_user_management_delete', {'id': user.id}) }}"
                        onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.');"
                        class="inline">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.id) }}">
                    <button class="inline-flex items-center gap-1 text-red-600 hover:text-red-700 font-semibold px-3 py-1 border border-red-300 rounded-lg hover:bg-red-50 transition">
                      ğŸ—‘ï¸ Delete
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="p-12 text-center">
      <p class="text-gray-500 text-lg">No users found. <a href="{{ path('app_user_management_new') }}" class="text-[#D62828] hover:underline font-semibold">Create one</a>.</p>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  
  <script>
    $(document).ready(function() {
      $('#usersTable').DataTable({
        responsive: true,
        pageLength: 10,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
        dom: '<"datatable-header"<"datatable-controls"lf>>t<"datatable-footer"<"datatable-info"i><"datatable-pagination"p>>',
        columnDefs: [
          { targets: 4, orderable: false }
        ],
        language: {
          lengthMenu: "Show _MENU_ entries",
          search: "Search:",
          info: "Showing _START_ to _END_ of _TOTAL_ entries",
          paginate: {
            previous: "Previous",
            next: "Next"
          }
        }
      });
    });
  </script>
{% endblock %}
